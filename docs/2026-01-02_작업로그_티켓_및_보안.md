# 2026-01-02 작업 로그: 티켓 시스템 통합 및 데이터 보안 강화

## 1. 개요
본 세션에서는 '가보자고(Gabojago)'와 '와요(Wayo)'의 통합 시나리오인 **티켓 시스템**을 구현하고, 사용자 경험과 보안을 위해 **데이터 격리(Data Isolation)** 작업을 수행했습니다.

## 2. 주요 작업 내용

### A. 티켓 시스템 (Ticket System) & QR 코드
이벤트 주최자가 초대장에 '티켓'을 동봉하고, 게스트가 RSVP(참석 응답) 시 자동으로 티켓(QR 코드)을 발급받는 기능을 구현했습니다.

*   **백엔드 (Rails)**
    *   `Ticket` 모델 개선: `user_id`를 선택적(nullable)으로 변경하고 `invitation_guest_id`를 추가하여, 비회원(익명 게스트)도 티켓을 가질 수 있도록 DB 스키마를 유연하게 변경했습니다.
    *   `InvitationGuestsController`: 게스트가 '참석(attending)'으로 응답 시, `TicketType`이 존재하면 자동으로 `Ticket` 레코드를 생성하도록 로직을 추가했습니다.
    *   API 응답: 게스트 조회 API가 티켓 정보(QR 코드 값)를 포함하여 반환하도록 수정했습니다.

*   **프론트엔드 (Next.js)**
    *   **초대장 만들기 (`/invitations/create`)**: '티켓 선택' 단계를 추가하여 주최자가 티켓 유형을 지정할 수 있게 했습니다.
    *   **초대장 상세 (`/invitations/[id]`)**: RSVP 완료 페이지에 QR 코드를 표시하는 UI를 추가했습니다. (`api.qrserver.com` 활용)

### B. 데이터 격리 및 보안 강화 (Security & Isolation)
사용자 피드백("이전 사용자 정보가 남으면 안 된다")을 반영하여, 로그인 세션과 로컬 데이터 간의 엄격한 격리 정책을 적용했습니다.

*   **강제 마이그레이션 방지**
    *   `development.rb` 설정에서 `migration_error` 체크를 해제하고, `docker-entrypoint` 및 `setup` 스크립트의 자동 DB 변경(`db:prepare`) 명령을 비활성화했습니다. DB는 항상 수동 관리됨을 원칙으로 합니다.

*   **프론트엔드 데이터 흐름 개선**
    *   **초대장 관리 (`/invitations/manage`)**: 
        *   로그인 상태(`authToken` 존재)에서는 오직 **서버 DB**의 데이터만 조회합니다.
        *   로그아웃 상태에서만 로컬 스토리지(`pending_invitations`)를 참조합니다.
    *   **로그인/로그아웃 클린업**:
        *   로그아웃 시 `pending_invitations` 및 `wayo_guest_*` 등 임시 데이터를 즉시 삭제하도록 `ProfilePage`를 수정했습니다.
        *   로그인 시에도 만약을 대비해 이전 임시 데이터를 소거하는 로직을 `LoginPage`에 추가했습니다.
    *   **상세 페이지 본인 확인**:
        *   로그인 유저는 `Item`이나 `LocalStorage` 키가 아닌, 실제 **User ID**를 대조하여 본인의 RSVP 내역을 찾도록 로직을 강화했습니다.

## 3. 결과 및 테스트
*   **통합 테스트 완료**: 초대장 생성 -> 티켓 선택 -> 비회원/회원 RSVP -> 티켓 발급 -> QR 코드 확인 프로세스가 정상 작동함을 확인했습니다.
*   **보안 테스트 완료**: A 사용자 로그인 작업 후 로그아웃 -> B 사용자 로그인 시 A의 초대장 목록이 보이지 않음을 확인했습니다.

## 4. 향후 계획 (Next Steps)
*   [ ] **내 티켓 지갑 (My Tickets)**: 발급받은 티켓들을 모아볼 수 있는 페이지 개발
*   [ ] **QR 스캐너 (Admin)**: 행사 현장에서 스태프가 QR 코드를 스캔하여 입장 처리하는 기능 개발
